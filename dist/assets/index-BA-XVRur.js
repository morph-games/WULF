var mt=Object.defineProperty;var ft=(a,t,e)=>t in a?mt(a,t,{enumerable:!0,configurable:!0,writable:!0,value:e}):a[t]=e;var N=(a,t,e)=>ft(a,typeof t!="symbol"?t+"":t,e);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))s(n);new MutationObserver(n=>{for(const r of n)if(r.type==="childList")for(const i of r.addedNodes)i.tagName==="LINK"&&i.rel==="modulepreload"&&s(i)}).observe(document,{childList:!0,subtree:!0});function e(n){const r={};return n.integrity&&(r.integrity=n.integrity),n.referrerPolicy&&(r.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?r.credentials="include":n.crossOrigin==="anonymous"?r.credentials="omit":r.credentials="same-origin",r}function s(n){if(n.ep)return;n.ep=!0;const r=e(n);fetch(n.href,r)}})();const U=320,Z=200,E={up:[0,-1],down:[0,1],left:[-1,0],right:[1,0],here:[0,0]},gt=20,wt=5,yt=["up","right","down","left"],bt=0,vt=10,Ct={main:{url:"./images/wulf-spritesheet-11.png",size:16,atlas:[{names:["grass-0","grass-1","grass-2","grass-3","forest-0","forest-1","forest-2","forest-3","mountain-0","mountain-1","mountain-2","mountain-3","mountain-door","circle","village","town","city","","faded-place","place"]},{names:["water-0","void","","","","","","","water-1","","","","","","","","ladder-down","ladder-up","magic-ladder-down","magic-ladder-up"]},{names:["dirt","floor-0","floor-1","floor-2","floor-3","floor-4","floor-5","floor-6","","","","","","","","","pillar-0","torch-0","torch-1","torch-2"]},{names:["stone-wall-0","stone-wall-1","stone-door-open","stone-window","stone-sign-left","stone-sign-right","dark-stone-0","dark-stone-1","dark-stone-to-stone","stone-to-dark-stone","green-stone"]},{names:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T"]},{names:["U","V","W","X","Y","Z","rune-A","rune-B","rune-C","rune-D","rune-E","rune-F","rune-G","rune-H","rune-I","rune-J","rune-K","rune-L","rune-M","rune-N"]},{names:["rune-O","rune-P","rune-Q","rune-R","rune-S","rune-T","rune-U","rune-V","rune-W","rune-X","rune-Y","rune-Z","rune-TH","rune-EE","rune-NG","rune-EA","rune-ST","rune-space","",""]},{names:["horse","horseback","empty-sailboat","sailboat","empty-galleon","galleon","empty-carpet","flying-carpet","empty-broom","flying-broom","dead-skull","hit-splash","target-circle"]},{names:["spearman-0","spearman-1","spearman-2","spearman-3","beastman-0","","","","king-0","","","","man-0","","","","woman-0","","",""]},{names:["orc-0","orc-1","orc-2","orc-3","wildman-0"]},{names:["dwarf-0"]},{names:["elf-0"]}]},fonts:{url:"./images/letters-spritesheet-5.png",size:8,atlas:[{names:["a","b","c","d","e","f","g","h","i","j","k","l","m","n","o","p","q","r","s","t","u","v","w","x","y","z","th","ee","ng","ea","st"," ","0","1","2","3","4","5","6","7","8","9","10","-","=",";",",",".","'","/"]},{names:["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z","TH","EE","NG","EA","ST"," ","ankh","!","@","#","$","%","^","&","*","(",")","_","+",":","<",">",'"',"?"]},{names:["rune-A","rune-B","rune-C","rune-D","rune-E","rune-F","rune-G","rune-H","rune-I","rune-J","rune-K","rune-L","rune-M","rune-N","rune-O","rune-P","rune-Q","rune-R","rune-S","rune-T","rune-U","rune-V","rune-W","rune-X","rune-Y","rune-Z","Trune-H","Erune-E","Nrune-G","Erune-S","Srune-T","rune-space"]}]}},Et={entity:{sprite:"void",x:0,y:0,obstacleId:0},terrain:{type:"entity",isTerrain:!0},void:{type:"terrain",sprite:"void",obstacleId:0},dirt:{type:"terrain",sprite:"dirt",obstacleId:6},floor2:{type:"terrain",sprite:"floor-2",obstacleId:7},floor3:{type:"terrain",sprite:"floor-3",obstacleId:7},floor4:{type:"terrain",sprite:"floor-4",obstacleId:7},floor5:{type:"terrain",sprite:"floor-5",obstacleId:7},grass:{type:"terrain",sprite:"grass-0",obstacleId:5},water:{type:"terrain",sprite:"water",variations:2,obstacleId:2},forest:{type:"terrain",sprite:"forest-0",obstacleId:10},mountain:{type:"terrain",sprite:"mountain-0",obstacleId:11},wall:{type:"terrain",sprite:"stone-wall-0",obstacleId:1},darkWall:{type:"terrain",sprite:"dark-stone-0",obstacleId:1},door:{type:"terrain",sprite:"stone-door-open",obstacleId:0},window:{type:"terrain",sprite:"stone-window",obstacleId:1},floor:{type:"terrain",sprite:"floor-0",obstacleId:7},tileFloor:{type:"terrain",sprite:"floor-2",obstacleId:7},signLeft:{type:"terrain",sprite:"stone-sign-left",obstacleId:1},signRight:{type:"terrain",sprite:"stone-sign-right",obstacleId:1},destination:{type:"entity",investigate:{message:"You see {{name}}."},enter:{},sprite:"mountain-door",isDestination:!0},town:{type:"destination",sprite:"town"},city:{type:"destination",sprite:"city"},village:{type:"destination",sprite:"village"},dungeon:{type:"destination",sprite:"mountain-door"},prop:{type:"entity",isProp:!0},ladderDown:{type:"prop",sprite:"ladder-down",klimbable:{speed:1,direction:"down"}},ladderUp:{type:"prop",sprite:"ladder-up",klimbable:{speed:1,direction:"up"}},torch:{type:"prop",sprite:"torch-0"},pillar:{type:"prop",sprite:"pillar-0"},actor:{type:"entity",sprite:"horse",deadSprite:"dead-skull",isActor:!0,action:{queue:[],cooldown:1},mover:{speed:1,transversal:[1,0,0,0,.5,1,1.1,1.2,.5,.9,.8,0,0,0,0],movesCount:0},health:{hp:99,hpMax:99,deathSprite:"void"},fighter:{},attacker:{range:1,natural:{damage:1,damageType:"ph"}},firer:{range:3},currencies:{coins:0,food:10},inventory:{contents:[],max:255},equipment:{},obstacleId:13},avatar:{type:"actor",isAvatar:!0,sprite:"spearman-0",enterer:{speed:1},exitor:{speed:1},klimber:{speed:1},health:{hp:99,hpMax:99,respawnOnDeath:!0},currencies:{coins:0,food:99},eater:{moveMeal:1},attacker:{range:1,natural:{damage:[5,10],damageType:"ph"}},inventory:{contents:[],max:255},experience:{totalXp:0,killXp:100},factions:{good:10,evil:0}},king:{type:"actor",sprite:"king-0"},wanderer:{type:"actor",sprite:"man-0",plan:{randomMove:.5}},man:{type:"wanderer"},woman:{type:"wanderer",sprite:"woman-0"},guard:{type:"wanderer",sprite:"spearman-2"},sentry:{type:"actor",sprite:"spearman-2"},elf:{type:"wanderer",sprite:"elf-0"},dwarf:{type:"wanderer",sprite:"dwarf-0",shop:{buy:{any:["item"]},sell:{types:["dagger","mace","axe","ropeAndSpikes","sword","greatSword","bow","amulet","wand","staff"],gateByMovesCount:[0,0,0,0,1500,1500,3e3,3e3,3e3,3e3]}}},monster:{type:"actor",factions:{good:-255,evil:255},plan:{randomMove:.5,aggroRange:10,hunt:!0},fighter:{},attacker:{range:1,natural:{damage:[1,4],damageType:"ph"}},firer:{range:0},health:{hp:12,hpMax:12,respawnOnDeath:!1}},beastman:{type:"monster",sprite:"beastman-0",currencies:{coins:[0,10],food:0},experience:{killXp:10}},darkHorseman:{type:"monster",sprite:"horseback",currencies:{coins:[0,10],food:[0,10]},experience:{killXp:10}},orc:{type:"monster",sprite:"orc-0",currencies:{coins:[0,10],food:[0,10]},experience:{killXp:10}},wildman:{type:"monster",sprite:"wildman-0",currencies:{coins:[0,10],food:0},experience:{killXp:10}},item:{type:"entity",isItem:!0,valuable:{valueMultiplier:1},sprite:"torch-0"},carpet:{type:"item",sprite:"empty-carpet"},broom:{type:"item",sprite:"empty-broom"},horse:{type:"item",sprite:"horse"},sailboat:{type:"item",sprite:"empty-sailboat"},galleon:{type:"item",sprite:"empty-galleon"},weapon:{type:"item",isWeapon:!0,equippable:{slots:["anyHand"]},attackable:{range:1,damage:1,type:"ph"}},dagger:{attackable:{damage:8,range:1,type:"ph"},type:"weapon"},mace:{attackable:{damage:16,range:1,type:"ph"},type:"weapon"},axe:{attackable:{damage:24,range:1,type:"ph"},type:"weapon"},ropeAndSpikes:{attackable:{damage:1,range:1,type:"ph"},type:"weapon"},sword:{attackable:{damage:40,range:1,type:"ph"},type:"weapon"},greatSword:{attackable:{damage:48,range:1,type:"ph"},type:"weapon"},bow:{attackable:{damage:56,range:1,type:"ph"},type:"weapon"},amulet:{buff:{spellDamageBonus:.5},type:"weapon"},wand:{buff:{spellDamageBonus:1},type:"weapon"},staff:{buff:{spellDamageBonus:2},type:"weapon"},triangle:{buff:{spellDamageBonus:2},attackable:{damage:88,range:1,type:"ph"},type:"weapon"},pistol:{attackable:{damage:96,range:1,type:"ph"},type:"weapon"},lightSword:{attackable:{damage:104,range:1,type:"ph"},type:"weapon"},phazor:{attackable:{damage:112,range:1,type:"ph"},type:"weapon"},blaster:{attackable:{damage:120,range:1,type:"ph"},type:"weapon"},armor:{type:"item",isArmor:!0},leatherArmor:{type:"armor",buff:{defense:2},valuable:10},chainArmor:{type:"armor",buff:{defense:4},valuable:25},plateArmor:{type:"armor",buff:{defense:6},valuable:60},vacuumArmor:{type:"armor",buff:{defense:9},valuable:120},reflectArmor:{type:"armor",buff:{defense:14},valuable:280}},Tt={name:"Lands of Lord Lunic",mapType:"overworld",map:["~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~.......f~~~....~~~~~~~~~~~","~~~~.....B..f~~~....~~~~~~~~~~~","~~~~..ff.....g~..f..~~~~~","~~~...^f.....sfffff.~~~~~","~~~..^^^.......fffff.~~~~","~~~..^^^....d...3fff...","~~~..^D........fffff..","~~~.^^^^....h....ff..","~~~..^^^b.c.....O..ff..","~~~~..^...........f..","~~~...^......2......~~~~.1~~","~~~........f..~~~~..~~~~~.f~","~~~.f^...^^^f....~~~~","~~~.f^^.^^^^ff~~~~~~~","~~~~^^...f^^ffff~~~~~","~~~~^.~..f^^^fff~~~~~","~~~~~~~f.ff^fff^~~~~~","~~~...ff...ff.^^^.1~~","~~~.........^^^^^^^^..~~~~......","~~..~........ff.^^^^^^^ff......","~~~~~~........f...............","~~~~~~~.~~.......~..~","~~~~~~~~~~~~~.~~~~~~~~~","~~~~~~~~~~~..O~~~~~~~~~~","~~~~~~~~~~~~....~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~..........~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~..fff..............~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~...~...........................ffffff........~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~...~^^^...................fffffffffffff^^......~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~.....^^................................^^.B........~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~....^^^................................^^^..B............~~~~~~~~~~~~~~~~~~~~~","~~~~~~~....^^^^............^^ffff.............^^^^^.................~~~~~~~~~~~~~~~~","~~~~~~~~........W...................W.................................~~~~~~~~~~~~~~","~~~~~~~~~..................................................................~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~","~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"],legend:{1:["grass","village"],2:["grass","town"],3:["grass",{type:"city",enter:{mapKey:"castle1"}}],D:["grass",{type:"dungeon",enter:{mapKey:"dungeon1"}}],K:["grass",{type:"king"}],G:["grass","guard"],W:["grass","wildman"],c:["grass","carpet"],h:["grass","horse"],s:["water","sailboat"],g:["water","galleon"],b:["grass","broom"],d:["grass","dwarf"]},spawn:{types:["beastman"],max:10,cooldownMulitplier:1},overflow:"water",exits:{edges:"LOOP"}},St={name:"Castle Albarix",mapType:"civilization",map:[".....................",".###################.",".#~~~-----------~~~#.",".#~~~-|--###--|-~~~#.",".#~~-----(K)-----~~#.",".#~---|-------|---~#.",".#-----------------#.",".#-S----*---*----S-#.",".#########-#########.",".%F.....F---F.....F%.",".%F......---......F%.",".###U####---####U###.",".#------#---#--W---#.",".#------#---#------#.",".#---M--#---####U###.",".%------U----------%.",".#------#----------#.",".####U###---######U#.",".#------#---#----#-#.",".#------#---#----#-#.",".#-D----#---#-E--U-#.",".#----D-#---######-#.",".########---#----#-#.",".#------U---#----U-#.",".#------#---#----#-#.",".#-####-#---######U#.",".#-G----#---#-E----#.",".#------#---#------#.",".####U###---######U#.",".#------#---#--G---#.",".#-->---#---#------#.",".######%#UUU#%######.","..ff..:::::::::..ff..","......:.~~~~~.:......","....*.:.~~~~~.:.*....",".####.D.~~~~~.:.####.",".#--S::.......::S--#.",".##%#.:::---:::.#%##.","....................."],legend:{U:["door"],"%":["window"],F:["forest"],S:["floor","sentry"],G:["floor","guard"],K:["floor","king"],M:["floor","man"],W:["floor","woman"],"(":["signLeft"],")":["signRight"],">":["floor","ladderDown"],E:["floor","elf"],D:["floor","dwarf"]},overflow:"grass",entrance:["center","bottom"],exits:{edges:["overworld",16,6],down:["castle1B",-1,-1]}},xt={name:"Castle Albarix Cellar",mapType:"civilization",map:["###################","#~~#-----------#~~#","#~~#--|-###-|--#~~#","#~~#-----------#~~#","####-----------####","#-----|-----|-----#","#-----------------#","#########U#########","#:::::::---:::::::#","#:::::::---:::::::#","###U####---########","#------#---U------#","#------#---#------#","#--G---#---########","#------U---#------#","#---*--#---U------#","########---########","#::::::#---|------#","#::::::U---------*#","#::::::#---|------#","#::::::#---########","########---#----*-#","#*-----U---U--G---#","#------#---#------#","#-|-G|-#######U####","#----------|-----*#","#-----------------#","#-#--#-##########U#","#------#------G---#","#--<---#---*------#","###################"],legend:{U:["door"],G:["floor","guard"],"<":["floor","ladderUp"]},entrance:["center","bottom"],exits:{edges:"BLOCK",up:["castle1",1,1]}},kt={name:"Dungeon",mapType:"dungeon",map:["#####################","#####################","##~~~-----------~~~##","##~~~-|--###--|-~~~##","#########.-##########","#:.....:-.--:::...:.#","#:......--:-......::#","###U####-.--####U####","#------#-.--#--W---##","#------#.---#------##","#---W--#-.--####U####","#------U--.--------%#","#-----...:.:::..---.#","####U###-.--######U.#","#------#.---#----#-.#","#------#.---#----#-.#","#-B----#.---#-B--U-.#","#----O-#.---######-.#","########--.-#----#..#","#------U--.-#----U..#","#------#--.-#----#..#","#-####-#--.-######U##","##-O----#--.#-B::::##","##------#--.#------##","#####U###---######U##","##------#---#--B---##","##------#---#------##","#######%#UUU#%#######","#~.W..:::::::::.....#","#~~~..:.~~.~~.:.....#","#..~*.:.~~.~~.:.*...#","##-~.::.......::---##","###:#.:::---:::.#W###","##########.##########"],legend:{".":["floor3"],"-":["floor5"],U:["door"],"%":["window"],F:["forest"],S:["floor","sentry"],G:["floor","guard"],K:["floor","king"],M:["floor","man"],W:["floor","wildman"],"(":["signLeft"],")":["signRight"],">":["floor","ladderDown"],E:["floor","elf"],D:["floor","dwarf"],"#":["darkWall"]},overflow:"void",entrance:["center","bottom"],exits:{edges:["overworld",16,6]}},w=8,At=U/w,B=Z/w,Dt=U/w,q=Math.floor(Dt/2),Mt={settings:{bumpCombat:1,autoEnter:0,language:"en"},spritesheets:Ct,screen:{containerSelector:"#screen",mainCanvasId:"main-canvas",height:Z,width:U,colors:{blue:"#2bcfd6",green:"#53d638",violet:"#962ba5",orange:"#d95e1c",white:"#f1f1f1",black:"#000000"}},mapDisplay:{w:20,h:10,offsetX:0,offsetY:1},mainConsole:{horizontal:"left",vertical:"bottom",rows:4,columns:At-10,cursor:">",fontSize:w,offsetX:0,offsetY:-2},quickStatConsole:{horizontal:"right",vertical:"bottom",rows:4,columns:9,fontSize:w,offsetX:-2,offsetY:-2},commandConsoles:[{horizontal:1,vertical:1,rows:B-2,columns:q-1,fontSize:w},{horizontal:q+1,vertical:1,rows:B-2,columns:q-2,fontSize:w}],centralConsole:{horizontal:"left",vertical:"top",rows:21,columns:36,fontSize:w,offsetX:w*2,offsetY:w*2},world:{obstacleTypes:["none","impassable physical obstacle","deep ocean","shallow water","swamp","plains","path","road","desert","hills","forest","low mountains","high mountains","short physical obstacle","lava","magical barrier",""],entityTypes:Et,mapTypes:{overworld:{moveMealMultiplier:1,moveXpMultiplier:1,scale:"overworld"},civilization:{moveMealMultiplier:0,moveXpMultiplier:0,scale:"personal"},dungeon:{moveMealMultiplier:1,moveXpMultiplier:1,scale:"personal"}},maps:{overworld:Tt,castle1:St,castle1B:xt,dungeon1:kt},globalLegend:{".":["grass"],":":["dirt"],"~":["water"],"^":["mountain"],f:["forest"],"-":["floor"],"*":["floor","torch"],"|":["floor","pillar"],"#":["wall"],B:["grass","beastman"],O:["grass","orc"]},timing:{actionCooldown:20,actionCooldownRandom:4,actionWarmup:5,actionWarmupRandom:0,overworldEating:100,townEating:1e4,regen:120,spawnCooldown:80,spawnCooldownRandom:50}},stats:{min:0,max:99,list:[{name:"Strength"}]},start:{mapKey:"overworld",coordinates:[10,10]},states:{direction:{kb:{ArrowUp:"up",ArrowDown:"down",ArrowLeft:"left",ArrowRight:"right",w:"up",s:"down",a:"left",d:"right",q:"abort",Escape:"abort",Enter:"abort"," ":"abort"}},stats:{kb:{q:"close",Escape:"close",Enter:"next"," ":"next"}},ready:{kb:{w:"ready weapon",a:"ready armor",s:"ready spell",q:"abort",Escape:"abort",Enter:"abort"," ":"abort"}},cast:{kb:{ArrowUp:"up",ArrowDown:"down",w:"up",s:"down",q:"abort",Escape:"abort",Enter:"abort"," ":"abort"}},item:{kb:{ArrowUp:"up",ArrowDown:"down",w:"up",s:"down",q:"abort",Escape:"abort",Enter:"abort"," ":"abort"}},shop:{kb:{Tab:"nextTab",ArrowRight:"add",ArrowLeft:"subtract",ArrowDown:"next",ArrowUp:"previous",a:"subtract",d:"add",s:"next",w:"previous",Escape:"abort","-":"subtract","=":"add","+":"add","[":"previousTab","]":"nextTab"," ":"add",t:"talk",Enter:"complete"}},commands:{kb:{ArrowUp:"previous",ArrowDown:"next",ArrowLeft:"previous",ArrowRight:"next",w:"previous",a:"previous",s:"next",d:"next",Escape:"abort",Enter:"execute"," ":"execute","?":"abort",F1:"abort"}},navigate:{kb:{ArrowUp:"previous",ArrowDown:"next",ArrowLeft:"previous",ArrowRight:"next"}},travel:{hideCommands:["/","0","1","=","G","Q","Enter"],kb:{" ":"pass",Tab:"toggle party",Enter:"chat","/":"command",0:"party return",1:"party 1",a:"go left",b:"board",c:"cast",d:"go right",e:"engage",f:"fight direction",g:"get nearby",h:"hole up",i:"investigate",j:"junk item",k:"klimb",l:"look direction",m:"map",n:"navigate",o:"open nearby",p:"pickpocket nearby",q:"quicksave",r:"ready item",s:"go down",t:"talk nearby",u:"use item",v:"view toggle",w:"go up",x:"eXit",y:"yell",z:"ztats",ArrowUp:"go up",ArrowDown:"go down",ArrowLeft:"go left",ArrowRight:"go right","+":"volume up","=":"volume up","-":"volume down","?":"see commands",F1:"see commands"},keyHelp:{e:{en:"enter/engage"},f:{en:"fight"},l:{en:"look"},o:{en:"open"},p:{en:"pickpocket"},t:{en:"talk"}}}},actions:{board:{cooldown:1},camp:{cooldown:2},cast:{cooldown:1},engage:{cooldown:0},enter:{cooldown:1},dismount:{cooldown:.6},fight:{cooldown:1},fire:{cooldown:1},get:{cooldown:.6},heal:{cooldown:2},hyperjump:{cooldown:.1},ignite:{cooldown:.6},investigate:{cooldown:2},junk:{cooldown:.8},jump:{cooldown:.1},jimmy:{cooldown:2},klimb:{cooldown:1,warmup:.9},launch:{cooldown:.1},locate:{cooldown:.1},mix:{cooldown:3},move:{cooldown:1},navigate:{cooldown:3},negate:{cooldown:.9},open:{cooldown:.5},offer:{cooldown:1},pass:{cooldown:1},pickpocket:{cooldown:.5,warmup:2},peer:{cooldown:1},plan:{cooldown:.2},push:{cooldown:1},ready:{cooldown:.9},summon:{cooldown:1},talk:{cooldown:1},transact:{cooldown:2},unlock:{cooldown:2},warmup:{cooldown:.6},yell:{cooldown:.1}}};class It{constructor(t,e=320,s=200){var n;this.elementId=t,this.canvas=document.getElementById(t),this.ctx=(n=this.canvas)==null?void 0:n.getContext("2d"),this.width=Number(e)||320,this.height=Number(s)||200}setup(){this.canvas=document.getElementById(this.elementId),this.ctx=this.canvas.getContext("2d")}removePixelTransparency(t=200){const{ctx:e}=this;e.imageSmoothingEnabled=!1;const s=e.getImageData(0,0,this.width,this.height);for(let n=0;n<s.data.length;n+=4){const r=s.data[n+3];s.data[n+3]=r>t?255:0}e.putImageData(s,0,0)}drawLine(t,e,s,n,r="#ffffff"){const{ctx:i}=this;i.beginPath(),i.strokeStyle=r,i.lineWidth=1,i.moveTo(t+.5,e+.5),i.lineTo(s+.5,n+.5),i.stroke()}}class b extends Image{constructor(t){if(super(),!t)throw new Error("GameImage missing src param");this.src=t,this.data=null,this.isLoaded=!1}async load(){const t=new Promise((e,s)=>{try{const n=()=>e(this);super.onload=n,super.onerror=r=>{console.error(this.src,r),s(new Error(`GameImage failed to load ${this.src}`))},this.complete&&n()}catch(n){s(n)}});try{await t,this.isLoaded=!0,this.setup()}catch(e){throw this.isLoaded=!1,e}return this}setup(){this.data=this.getImageData()}async clone(){const t=new b(this.src);return await t.load(),t}cloneSync(){const t=new b(this.src);return t.load(),t}static getCanvasContext(t,e,s){const n=document.createElement("canvas");n.width=t,n.height=e;const r=n.getContext("2d");return s&&r.drawImage(s,0,0),[n,r]}getCanvasContext(t={}){const{draw:e=!0}=t;return b.getCanvasContext(this.naturalWidth||this.width,this.naturalHeight||this.height,e?this:null)}getImageData(t){return(t||this.getCanvasContext({draw:!0})[1]).getImageData(0,0,this.width,this.height)}getImageDataUri(){const[t]=this.getCanvasContext({draw:!0});return t.toDataURL("image/png")}setSourceByCanvas(t){this.src=t.toDataURL("image/png")}replaceColors(t=[],e=[]){const[s,n]=this.getCanvasContext({draw:!0}),r=this.getImageData(n);for(let i=0;i<r.data.length;i+=4)t.forEach((o,l)=>{const[c,h,u]=o,[d,p,v]=e[l];r.data[i]===c&&r.data[i+1]===h&&r.data[i+2]===u&&(r.data[i]=d,r.data[i+1]=p,r.data[i+2]=v)});n.putImageData(r,0,0),this.setSourceByCanvas(s)}replaceColor(t=[],e=[]){const[s,n]=this.getCanvasContext({draw:!0}),[r,i,o]=t,[l,c,h]=e;let u=0;const d=this.getImageData(n);for(let p=0;p<d.data.length;p+=4)d.data[p]===r&&d.data[p+1]===i&&d.data[p+2]===o&&(d.data[p]=l,d.data[p+1]=c,d.data[p+2]=h,u+=1);return n.putImageData(d,0,0),this.setSourceByCanvas(s),u}}const T=[[255,255,255],[0,0,0]],Lt=[[238,238,204],[17,17,51]],Wt=0;class k extends b{constructor(t,e={},s=16){const n=typeof t=="object",r=n?(t==null?void 0:t.src)||(t==null?void 0:t.url):t;super(r);const i=(n?t==null?void 0:t.atlas:e)||[];this.atlas=[...i];const o=(n?t==null?void 0:t.size:s)||16;this.spriteSize=o,this.sprites={}}async load(){try{await super.load()}catch(t){throw console.error(t),t}}getCoordinates(t){let e=-1,s=-1;if(this.atlas.forEach((n,r)=>{if(!n.names)return;const i=n.names.findIndex(o=>t===o);i!==-1&&(s=i,e=r)}),s===-1||e===-1)throw new Error(`Sprite ${t} not found in atlas`);return[s*this.spriteSize,e*this.spriteSize]}drawImageToContext(t,e,s,n){const[r,i]=this.getCoordinates(t);e.drawImage(this,r,i,this.spriteSize,this.spriteSize,s,n,this.spriteSize,this.spriteSize)}getSubImage(t,e,s=this.spriteSize,n=this.spriteSize,r=void 0,i=void 0){if(!r||!i){const l=b.getCanvasContext(s,n);r=l[0],i=l[1]}i.drawImage(this.sheet,t,e,s,n,0,0,s,n);const o=r.toDataURL("image/png");return new b(o)}parse(){const[t,e]=b.getCanvasContext(this.spriteSize,this.spriteSize);let s=0;Object.entries(this.atlas).forEach(([n,r])=>{let i=0;r.forEach(o=>{const{y:l,names:c}=o;let h=Wt;c.forEach(u=>{const d=this.getSubImage(h,l,this.spriteSize,this.spriteSize,t,e);[`sprite-${s}`,`${n}-${i}`,u].forEach(p=>{this.sprites[p]=d}),h+=this.spriteSize,s+=1,i+=1})})})}static makeColorId(t,e=T){const[s=[255,255,255],n=[0,0,0]]=e;return`${t}_${s.join(",")}_${n.join(",")}`}async loadColoredSprite(t,e=T){const s=this.makeColoredSprite(t,e);return await s.load(),s}async loadColorSpriteDataUri(t,e=T){const s=await this.loadColoredSprite(t,e);return s?s.getImageDataUri():""}makeColoredSprite(t,e=T){const[s=[255,255,255],n=[0,0,0]]=e,r=this.get(t);if(!r)throw new Error(`Unknown sprite ${t}`);const i=r.cloneSync();i.replaceColors(Lt,[s,n]);const o=k.makeColorId(t,e);return this.sprites[o]=i,i}makeColoredSpriteDataUri(t,e=T){return this.makeColoredSprite(t,e).getImageDataUri()}get(t,e){if(!e)return this.sprites[t];const s=k.makeColorId(t,e),n=this.sprites[s];return n||this.makeColoredSprite(t,e)}getDataUri(t,e){const s=this.get(t,e);return s?s.getImageDataUri():""}}class V{constructor(t,e={}){if(this.fss=t,this.cursorRow=0,this.cursorCol=0,this.offsetX=e.offsetX||0,this.offsetY=e.offsetY||0,!t)throw new Error("Missing fonts spritesheet")}static splitText(t,e){if(t.length<=e)return[t];const s=t.split(" "),n=[];let r="";return s.forEach(i=>{i.length>e&&console.warn("Word exceeds max length",i,e);const o=r?`${r} ${i}`:i;o.length>e?(n.push(r),r=i):r=o}),n.push(r),n}async setup(){await this.fss.load()}setCursor(t,e){typeof t=="number"&&(this.cursorCol=t),typeof e=="number"&&(this.cursorRow=e)}drawLetter(t,e){try{this.fss.drawImageToContext(e,t,this.cursorCol*this.fss.spriteSize+this.offsetX,this.cursorRow*this.fss.spriteSize+this.offsetY)}catch(s){console.warn("Error drawing letter",e,s)}this.cursorCol+=1}drawTextRows(t,e=[],s=void 0,n=void 0){this.setCursor(s,n);const r=this.cursorCol;e.forEach(i=>{i.split("").forEach(o=>{this.drawLetter(t,o)}),this.cursorRow+=1,this.cursorCol=r})}drawText(t,e="",s=void 0,n=void 0){if(this.setCursor(s,n),e instanceof Array){this.drawTextRows(t,e,s,n);return}e.split("").forEach(r=>{this.drawLetter(t,r)})}lineBreak(){this.cursorCol=0,this.cursorRow+=1}drawLine(t,e="",s=void 0,n=void 0){this.drawText(t,e,s,n),this.lineBreak()}}class A{constructor(t={},e=null){this.fontsSpritesheet=e,this.horizontal=t.horizontal||"left",this.vertical=t.vertical||"top",this.fontSize=t.fontSize||8,this.columns=t.columns||"max",this.rows=t.rows||4,this.offsetX=t.offsetX||0,this.offsetY=t.offsetY||0,this.inputLine=typeof t.inputLine>"u"?!0:!!t.inputLine,this.textRows=this.rows-(this.inputLine?1:0),this.cursor=t.cursor||"",this.gameCanvas=t.gameCanvas;const{offsetX:s,offsetY:n}=this;this.textCtrl=new V(e,{offsetX:s,offsetY:n}),this.log=[]}async setup(t){this.gameCanvas=t,await this.textCtrl.setup(),typeof this.columns!="number"&&(this.columns=Math.floor(this.gameCanvas.width/this.fontSize))}getColumnStart(){const t=U/this.fontSize;return this.horizontal==="right"?t-this.columns:this.horizontal==="left"?0:this.horizontal==="center"?Math.floor(t/2):Number(this.horizontal||0)}getRowBase(){var t;return this.vertical==="bottom"?Math.floor((((t=this.gameCanvas)==null?void 0:t.height)||0)/this.fontSize)-this.rows:this.vertical==="top"?0:Number(this.vertical||0)}getPrintableLines(){const t=this.cursor.length,e=" ".repeat(t),s=[];this.log.slice(-this.textRows).forEach(l=>{V.splitText(l,this.columns-t).forEach((c,h)=>{s.push(`${h===0?this.cursor:e}${c}`)})});const n=s.slice(-this.textRows),i=n.length<this.textRows?this.textRows-n.length:0;return[..." ".repeat(i).split("").map(()=>".".repeat(this.columns)),...n]}printLine(t,e=0){const s=this.getRowBase()+e,{ctx:n}=this.gameCanvas,r=t.length<this.columns?this.columns-t.length:0,i=this.getColumnStart();this.textCtrl.drawLine(n,t+" ".repeat(r),i,s)}printLines(t){(t||this.getPrintableLines()).forEach((s,n)=>this.printLine(s,n))}printCursor(){const t=this.getRowBase()+this.rows-1,{ctx:e}=this.gameCanvas;this.textCtrl.drawLine(e,this.cursor,0,t)}print(t){this.log.push(t),this.printLines(),this.printCursor()}clear(){const t=" ".repeat(this.rows).split("").map(()=>" ".repeat(this.columns));this.printLines(t)}}class C{constructor(t={}){var n,r,i,o,l,c,h,u,d,p,v,g,j,F,P;this.colors=((n=t.screen)==null?void 0:n.colors)||{white:"#ffffff",black:"#000000"},this.screenWidth=((r=t.screen)==null?void 0:r.width)||320,this.screenHeight=((i=t.screen)==null?void 0:i.height)||200,this.mapDisplayWidth=((o=t==null?void 0:t.mapDisplay)==null?void 0:o.w)||20,this.mapDisplayHeight=((l=t==null?void 0:t.mapDisplay)==null?void 0:l.h)||10,this.mapDisplayOffsetX=((c=t==null?void 0:t.mapDisplay)==null?void 0:c.offsetX)||0,this.mapDisplayOffsetY=((h=t==null?void 0:t.mapDisplay)==null?void 0:h.offsetY)||0;const e=(((d=(u=t.spritesheets)==null?void 0:u.main)==null?void 0:d.size)||16)*this.mapDisplayHeight+this.mapDisplayOffsetY,s=(((p=t.mainConsole)==null?void 0:p.columns)||10)*(((v=t.mainConsole)==null?void 0:v.fontSize)||8)+1;this.borderLines=[[0,e,this.screenWidth,e,this.colors.blue],[s,e,s,this.screenHeight,this.colors.blue]],this.screenSelector=((g=t.screen)==null?void 0:g.containerSelector)||"#wulf-screen",this.mainCanvasId=((j=t.screen)==null?void 0:j.mainCanvasId)||"wulf-main-canvas",this.gameCanvas=new It(this.mainCanvasId,[this.screenWidth,this.screenHeight]),this.ss=new k((F=t==null?void 0:t.spritesheets)==null?void 0:F.main),this.fontsSpritesheet=new k((P=t==null?void 0:t.spritesheets)==null?void 0:P.fonts),this.mainConsole=new A(t==null?void 0:t.mainConsole,this.fontsSpritesheet),this.quickStatConsole=new A(t==null?void 0:t.quickStatConsole,this.fontsSpritesheet),this.commandConsoles=t.commandConsoles.map(pt=>new A(pt,this.fontsSpritesheet)),this.centralConsole=new A(t==null?void 0:t.centralConsole,this.fontsSpritesheet)}static getPrintableNumber(t,e=4){if(typeof t!="number")return"?".repeat(e);let s=String(t);return s.length>e&&(s=`${String(Math.floor(t/1e3))}k`),s.padStart(e," ")}adjustScreenSize(){const t=window.innerWidth,e=window.innerHeight,s=Math.floor(Math.min(t/this.screenWidth,e/this.screenHeight)),n=this.screenWidth*s,r=this.screenHeight*s,i=document.querySelector(this.screenSelector);i.style.width=`${n}px`,i.style.height=`${r}px`}drawSprite(t,e,s){t&&this.ss.drawImageToContext(t,this.gameCanvas.ctx,e*this.ss.spriteSize+this.mapDisplayOffsetX,s*this.ss.spriteSize+this.mapDisplayOffsetY)}drawSprites2d(t){t.forEach((e,s)=>{e.forEach((n,r)=>{this.drawSprite(n,r,s)})})}drawSpritesArray(t=[]){t.forEach(e=>{const[s,n,r]=e;this.drawSprite(s,n,r)})}drawTerrain(t){this.drawSprites2d(t.terrain.sprites,"terrain")}drawVisibleThings(t=[]){t.forEach(e=>{const[s,n,r]=e;this.drawSprite(s,n,r)})}drawParty(t){const{visibleWorldX:e,visibleWorldY:s,sprite:n}=t.avatar;this.drawSprite(n,e,s)}drawMap(t,e,s){this.drawTerrain(t),this.drawVisibleThings(t.items),this.drawVisibleThings(t.props),this.drawVisibleThings(t.actors),this.drawParty(e),!s&&this.borderLines.forEach(n=>{this.gameCanvas.drawLine(...n)})}drawAll(t,e){var s,n,r,i,o,l,c,h;this.drawMap(t,e),this.quickStatConsole.printLines([`H.P.:${C.getPrintableNumber((n=(s=e==null?void 0:e.avatar)==null?void 0:s.health)==null?void 0:n.hp,4)}`,`Coin:${C.getPrintableNumber((i=(r=e==null?void 0:e.avatar)==null?void 0:r.currencies)==null?void 0:i.coins,4)}`,`Food:${C.getPrintableNumber((l=(o=e==null?void 0:e.avatar)==null?void 0:o.currencies)==null?void 0:l.food,4)}`,`X.P.:${C.getPrintableNumber((h=(c=e==null?void 0:e.avatar)==null?void 0:c.experience)==null?void 0:h.totalXp,4)}`])}drawCommandColumns(t=[]){const e=this.commandConsoles.length,s=Math.ceil(t.length/e),n=t.slice(0,s),r=t.slice(s);this.commandConsoles[0].printLines(n),this.commandConsoles[1].printLines(r)}drawCentralText(t=[]){this.quickStatConsole.clear(),this.mainConsole.clear(),this.centralConsole.clear(),this.centralConsole.printLines(t)}async setup(){await this.gameCanvas.setup(),this.adjustScreenSize(),await this.mainConsole.setup(this.gameCanvas),await this.quickStatConsole.setup(this.gameCanvas);const t=this.commandConsoles.map(e=>e.setup(this.gameCanvas));await this.centralConsole.setup(this.gameCanvas),await Promise.allSettled(t),window.addEventListener("resize",()=>this.adjustScreenSize())}}class Rt{constructor(t){this.gameName=t||"MyGame"}getObject(t){const e=localStorage.getItem(`${this.gameName}_${t}`);return typeof e!="string"?null:JSON.parse(e)}setObject(t,e=null){localStorage.setItem(`${this.gameName}_${t}`,JSON.stringify(e))}loadSavesList(){return this.getObject("Saves")||[]}saveSave(t,e,s){this.setObject(`Save${t}`,s);const n=this.loadSavesList();n[t]={saveName:e},this.setObject("Saves",n)}}class tt{constructor(){this.eventListeners={}}on(t,e){let s=this.eventListeners[t];s||(this.eventListeners[t]=new Set,s=this.eventListeners[t]),s.add(e)}off(t,e){if(typeof t>"u"){this.eventListeners={};return}const s=this.eventListeners[t];if(s){if(typeof e>"u"){s.clear();return}s.delete(e)}}trigger(t,e){const s=this.eventListeners[t];s&&s.forEach(n=>n(e))}}const et="command",st="missingCommand",nt="mount",rt="unmount",M="mapping",Ut=[et,st,nt,rt,M],H="keydown",G="keyup";class Nt extends tt{constructor(t={},e={}){super();const{autoMount:s=!0,triggerOnRepeat:n=!1,document:r=window.document}=e;if(this.id=Math.round(Math.random()*99999),this.triggerOnRepeat=!!n,this.mapping={},this.setMapping(t),this.document=r,!this.document.addEventListener)throw new Error("document with addEventListener is required");this.keysDown={},this.commandsDown={},this.keyDownListener=i=>this.handleKeyDown(i),this.keyUpListener=i=>this.handleKeyUp(i),this.setupEventListeners(e),this.nodeNamesDontTrigger=["TEXTAREA","INPUT"],this.nodeNamesAllowDefault=["TEXTAREA","INPUT"],s&&this.mount()}setMapping(t={}){if(typeof t!="object")throw new Error("Invalid type for mapping param");return this.mapping={...t},this.trigger(M),this.mapping}mapKey(t,e){return this.mapping[t]=e,this.trigger(M),!0}mapUnmappedKey(t,e){return this.mapping[t]?!1:this.mapKey(t,e)}unmapKey(t){return this.mapping[t]?!1:(delete this.mapping[t],this.trigger(M),!0)}mount(){this.document.addEventListener(H,this.keyDownListener),this.document.addEventListener(G,this.keyUpListener),this.trigger(nt)}unmount(){this.document.removeEventListener(H,this.keyDownListener),this.document.removeEventListener(G,this.keyUpListener),this.trigger(rt)}handleKeyDown(t){const{key:e,code:s,keyCode:n,altKey:r,ctrlKey:i,shiftKey:o,metaKey:l,repeat:c}=t,h={code:s,keyCode:n,altKey:r,ctrlKey:i,shiftKey:o,metaKey:l,repeat:c},{nodeName:u}=t.target;if(this.nodeNamesDontTrigger.includes(u))return;if(this.nodeNamesAllowDefault.includes(u)||t.preventDefault(),!c){const p=this.mapping[e];this.keysDown[e]=!0,p&&(this.commandsDown[p]=!0)}(!c||this.triggerOnRepeat)&&this.triggerKey(e,h)}handleKeyUp(t){const{key:e}=t,s=this.mapping[e];this.keysDown[e]=!1,s&&(this.commandsDown[s]=!1)}setupEventListeners(t={}){Ut.forEach(e=>{t[e]&&this.on(e,t[e])})}triggerCommand(t){this.trigger(et,t)}triggerMissingCommand(t){this.trigger(st,t)}triggerKey(t){const e=this.mapping[t];e?this.triggerCommand(e):this.triggerMissingCommand(t)}getKeysMapped(){return Object.keys(this.mapping)}getCommands(){const t=new Set;return this.getKeysMapped().forEach(e=>t.add(this.mapping[e])),Array.from(t)}isKeyDown(t){return this.keysDown[t]}isCommandDown(t){return this.commandsDown[t]}getKeysDown(){return Object.keys(this.keysDown).filter(t=>this.keysDown[t])}getCommandsDown(){return Object.keys(this.commandsDown).filter(t=>this.commandsDown[t])}clearDown(){this.keysDown={},this.commandsDown={}}}class qt{constructor(t){t||console.warn("No states param"),this.states=t||{},this.kbCommander=new Nt({},{triggerOnRepeat:!0})}setup(t="button"){document.querySelectorAll(t).forEach(e=>{e.dataset.key&&e.addEventListener("click",()=>{this.kbCommander.triggerKey(e.dataset.key)})})}on(t,e){this.kbCommander.on(t,e)}setState(t,e){var n;if(!this.states[t])throw new Error(`Unknown state ${t}`);const s=((n=this.states[t])==null?void 0:n.kb)||{};this.kbCommander.setMapping(s),this.kbCommander.off(),this.kbCommander.on("command",e),this.kbCommander.on("missingCommand",(...r)=>console.warn("Missing command",r))}}class x{constructor(t){this.allTypes={},this.allTypesArray=[],this.buildAllTypes(t)}static getExtendedType(t={},e={}){let s=structuredClone(t);const{type:n,typeKey:r}=s;if(s.types||(s.types=[]),r&&s.types.push(r),n)if(e[n]){const i=x.getExtendedType(e[n],e);s.types=[...i.types,n],s={...i,...s}}else console.error("Could not find type",t.type);return s.types=Array.from(new Set(s.types)),structuredClone(s)}getExtendedType(t={}){return x.getExtendedType(t,this.allTypes)}createEntityByType(t){return this.getExtendedType({type:t})}buildAllTypes(t){this.allTypes={},this.allTypesArray=[],Object.keys(t).sort().forEach(s=>{const n=t[s];if(this.allTypesArray[s]){console.error("Type",s,"already exists and will be skipped.");return}this.allTypes[s]=n,this.allTypesArray.push(n),n.typeKey&&n.typeKey!==s&&console.warn("Existing typeKey does not match",s,"and will be overwritten"),n.entTypeId=this.allTypesArray.length-1,n.typeKey=s}),console.log("All types:",this.allTypes),this.allTypesArray.forEach(s=>{const n=x.getExtendedType(s,this.allTypes);this.allTypes[n.typeKey]=n,this.allTypesArray[n.entTypeId]=n}),this.allTypesArray.forEach(s=>{s.name||(s.name=s.typeKey)})}get(t){return this.allTypes[t]}getTerrainSpriteName(t){const e=this.get(t);if(!e)return console.error("Unknown terrain key",t),"";const{sprite:s,variations:n}=e;if(!n)return s;const r=n?Math.floor(Math.random()*n):"0";return`${s}-${r}`}getEntitySpriteName(t){const e=this.get(t);if(!e)return"";const{sprite:s,variations:n}=e;if(!n)return s;const r=Math.floor(Math.random()*n);return`${s}-${r}`}}function $t(a,t=0,e=1){return a<t?t:a>e?e:a}function Ot(a=1,t=0){return t+Math.random()*(a-t)}function Yt(a,t=0){return Math.floor(Ot(a,t))}function L(a,t=0){const e=Math.max(a,t)+1;return Yt(e,Math.min(a,t))}function Kt(a,t,e,s){return(a-e)**2+(t-s)**2}function at(a,t,e,s){return Kt(a,t,e,s)**.5}const it=a=>new Promise(t=>{setTimeout(t,a)}),_=a=>a.charAt(0).toUpperCase()+a.slice(1);function zt(a,t){!a.currencies||!t.currencies||Object.entries(a.currencies).forEach(([e,s])=>{t.currencies[e]=(t.currencies[e]||0)+s,a.currencies[e]=0})}function Xt(a){a.currencies&&Object.entries(a.currencies).forEach(([t,e])=>{e instanceof Array&&(a.currencies[t]=L(e[0]||0,e[1]||0))})}class jt{constructor(t){this.entityTypes=t,this.all=[],this.nextEntId=this.all.length}add(t={}){const e=this.entityTypes.getExtendedType(t),s=structuredClone(e);Xt(s),this.all.push({...s,entId:this.nextEntId}),this.nextEntId+=1}addActor(t){const{whoId:e=`actor-ent-${this.nextEntId}`}=t;if(this.getActor(e))throw new Error(`Already have an actor with whoId ${e}`);this.add({...t,whoId:e,isActor:!0})}addAvatar(t){this.addActor({...t,type:"avatar",isAvatar:!0})}allAllFromMaps(t){t.reduce((s,n)=>[...s,...n.getEntities()],[]).forEach(s=>{const n=this.entityTypes.getExtendedType(s);n.isActor?this.addActor(n):this.add(n)}),console.log("All Entities",this.all)}getActor(t){return this.all.find(e=>e.whoId===t)}getAvatars(){return this.all.filter(t=>t.isAvatar)}getActors(){return this.all.filter(t=>t.isActor)}getAvatarMapIds(){const t=new Set;return this.getAvatars().forEach(e=>t.add(e.mapId)),[...t]}getActorsOnMap(t){return this.all.filter(e=>e.isActor&&e.mapId===t)}getEntitiesOnMap(t){return this.all.filter(e=>e.mapId===t)}getEntitiesOnMapRange(t,e=0,s=0,n=10,r=10){const i=e+n,o=s+r;return this.all.filter(l=>l.mapId===t&&l.x>=e&&l.x<i&&l.y>=s&&l.y<o)}}class W{constructor(t,e={},s=null){if(!t||typeof t!="object")throw new Error("Missing mapData object");this.mapKey=t.mapKey,this.id=t.id,this.globalLegend=Object.freeze(structuredClone(e)),this.entityTypes=s,this.base=Object.freeze(structuredClone(t)),this.time=0,this.exits=W.makeExits(this.base.exits),this.height=this.base.map.length,this.width=this.base.map.reduce((n,r)=>Math.max(n,r.length),0),this.maxX=this.width-1,this.maxY=this.height-1}static makeMaps(t={},e={},s={},n=null){const r=[];return Object.keys(t).sort().forEach(o=>{const l=r.length,c=t[o],h=s[c==null?void 0:c.mapType]||null,u=new W({...h,...c,mapKey:o,id:l},e,n);r.push(u)}),r}static makeExits(t={}){return{left:t.left||t.edges||"BLOCK",right:t.right||t.edges||"BLOCK",top:t.top||t.edges||"BLOCK",bottom:t.bottom||t.edges||"BLOCK",up:t.up||"BLOCK",down:t.down||"BLOCK"}}getEntities(){const t=this.id,{map:e,legend:s}=this.getData(),n=Object.keys(s).filter(o=>s[o].length>1),r=n.reduce((o,l)=>{const c=s[l].slice(1).map(h=>typeof h=="string"?{type:h}:h);return{...o,[l]:c}},{}),i=[];return e.forEach((o,l)=>{o.split("").forEach((c,h)=>{n.includes(c)&&r[c].forEach((u,d)=>{i.push({...structuredClone(u),mapId:t,x:h,y:l,origin:{mapId:t,x:h,y:l,legendIndex:d}})})})}),i}isOffEdge(t,e){return t<0||t>this.maxX||e<0||e>this.maxY}getOffEdge(t,e){return t<0?"left":t>this.maxX?"right":e<0?"top":e>this.maxY?"bottom":!1}getData(){const t={...this.globalLegend,...this.base.legend};return{...this.base,legend:t}}getName(){return this.getData().name||this.mapKey}getOverflowEntityType(){var t;return((t=this.getData())==null?void 0:t.overflow)||"void"}getExit(t){return this.exits[t]||"BLOCK"}getLoopedCoordinates(t,e){return[t>0?t%this.width:(t%this.width+this.width)%this.width,e>0?e%this.height:(e%this.height+this.height)%this.height]}getCellData(t,e){const{map:s,legend:n}=this.getData();if(t<0||e<0||s[e]===void 0||s[e][t]===void 0)return null;const r=s[e][t],i=n[r];return i||(console.warn("Missing",r,"at",t,e,s[e]),null)}getTopProperty(t,e,s){const n=this.getCellData(e,s);let r;for(let i=n.length-1;i>=0;i-=1)if(r=n[i],typeof r=="object"&&r[t]!==void 0)return r[t];return null}getTopEntityType(t,e){const s=this.getCellData(t,e);if(!s)return null;if(s.length===0)return this.getOverflowEntityType();const n=s[s.length-1];return typeof n=="string"?n:n.entityTypeKey||n.entityType||n.type||this.getOverflowEntityType()}getTerrainTypeKey(t,e){const s=this.getCellData(t,e);if(!s)return this.getOverflowEntityType();const[n]=s;return n}getTerrainEntity(t,e){const s=this.getTerrainTypeKey(t,e);return this.entityTypes.createEntityByType(s)}getEntranceCoordinates(){let[t=0,e=0]=this.getData().entrance||[];return t==="center"?t=Math.floor(this.width/2):t==="left"?t=0:t==="right"&&(t=this.maxX),e==="bottom"?e=this.maxY:e==="top"?e=0:e==="center"&&(e=Math.floor(this.height/2)),[Math.round(t),Math.round(e)]}}class Ft{constructor(t){this.queue=[],t.forEach(e=>this.add(e)),this.sort(),this.time=0}add(t){if(!t.action){console.warn("Actor does not have action component so cannot be added to schedule",t);return}this.queue.push(t),this.sort()}sort(){this.queue.sort((t,e)=>t.action.cooldown===e.action.cooldown?t.isAvatar?-1:0:t.action.cooldown-e.action.cooldown)}top(){return this.queue[0]}coolToTop(){const t=this.top(),[e,s,n]=t.action,r=n-this.time;return this.time=n,t.action.isWarmingUp=0,{whoId:e,isWarmingUp:s,deltaT:r}}}const Q=1,$="readwrite",Pt="readonly",S=5e3,{indexedDB:O,setTimeout:Bt,clearTimeout:J,URL:Vt,open:Ht}=window,f=class f{constructor(t,e,s=null){this.dbName=t||null,this.version=e||Q,this.db=s||null,this.timeout=S}static async openDatabase(t,e=Q,s,n){return new Promise((r,i)=>{const o=(c,h)=>{var u,d;console.error(c,(d=(u=h==null?void 0:h.target)==null?void 0:u.error)==null?void 0:d.message,h),i(new Error(`open database failed ${c}`))},l=O.open(t,e);l.onsuccess=c=>{var u;const h=(u=c==null?void 0:c.target)==null?void 0:u.result;n&&n(h,c),r(h)},l.onupgradeneeded=c=>{var u;const h=(u=c==null?void 0:c.target)==null?void 0:u.result;s&&s(h,c)},l.onerror=c=>o("error",c),l.onabort=c=>o("abort",c),l.onclose=c=>o("close",c)})}static openBlob(t){Ht(Vt.createObjectURL(t))}static makeTimedPromise(t,e="",s=S){return new Promise((n,r)=>{const i=Bt(()=>r(new Error(`Timed out ${e}`)),s);t((...c)=>{J(i),n(...c)},(c,...h)=>{J(i),console.error(c,h),r(new Error(`${c} ${e||""}`))})})}static waitForTransaction(t,e="",s=S){return f.makeTimedPromise((n,r)=>{t.oncomplete=i=>n(i),t.onerror=i=>r("error",i,t),t.onabort=i=>r("abort",i,t)},`transaction ${e}`,s)}static waitForRequest(t,e="",s=S){return f.makeTimedPromise((n,r)=>{t.onsuccess=i=>n(i.target.result),t.onerror=i=>r("error",i,t),t.onabort=i=>r("abort",i,t),t.onclose=i=>r("close",i,t)},`request ${e}`,s)}static waitForCursorValueRequest(t,e="",s=S){return f.makeTimedPromise((n,r)=>{const i=[];t.onsuccess=o=>{const l=o.target.result;if(l){i.push(l.value),l.continue();return}n(i)},t.onerror=o=>r("error",o,t)},`cursor request ${e}`,s)}async waitForRequest(t,e=""){return await f.waitForRequest(t,e,this.timeout),t}handleError(t,...e){console.error("SIDB Error:",t,...e)}async getDatabases(){return await O.databases()}getDatabaseName(){if(!this.db)throw new Error("db is missing");return this.db.name}getObjectStoreNames(){return this.db.objectStoreNames}hasObjectStoreName(t){return this.getObjectStoreNames().contains(t)}getTransaction(t,e=$){if(!this.db)throw new Error("db is missing");return this.db.transaction(t,e)}getObjectStore(t,e=$){return this.getTransaction(t,e).objectStore(t)}async addToObjectStore(t,e,s){const n=this.getObjectStore(t).add(e);return await this.waitForRequest(n,s||`add to ${t}`),n}async putToObjectStore(t,e,s){const n=this.getObjectStore(t).put(e);return await this.waitForRequest(n,s||`put to ${t}`),n}async deleteFromObjectStore(t,e,s){const n=this.getObjectStore(t).delete(e);return await this.waitForRequest(n,s||`delete ${e}`),n}async getFromObjectStore(t,e,s){const n=this.getObjectStore(t).get(e);return await this.waitForRequest(n,s||`get ${e}`),n}async readIndexCursorValues(t,e){const n=this.getObjectStore(t).openCursor();return await f.waitForCursorValueRequest(n)}setDatabase(t){this.db=t,t.onabort=(...e)=>this.handleError("abort",e),t.onclose=(...e)=>this.handleError("close",e),t.onerror=(...e)=>this.handleError("error",e),t.onversionchange=(...e)=>{console.warn("versionchange",e)}}close(){this.db&&(this.db.close(),this.db=null)}async delete(){this.close();const t=O.deleteDatabase(this.dbName);await f.waitForRequest(t,"delete")}async open(){this.close();const t=await f.openDatabase(this.dbName,version);return this.setDatabase(t),this.db}async create(t=()=>{}){await this.delete();const e=await f.openDatabase(this.dbName,this.version,t);return this.setDatabase(e),this.db}async upgrade(t=()=>{}){this.version+=1,this.close();const e=await f.openDatabase(this.dbName,this.version,t);return this.setDatabase(e),this.db}async createObjectStore(t,e){let s;return await this.upgrade(n=>{s=n.createObjectStore(t,e)}),s}async deleteObjectStore(t,e){let s;return await this.upgrade(n=>{s=n.deleteObjectStore(t,e)}),s}};N(f,"READ_WRITE",$),N(f,"READ_ONLY",Pt);let Y=f;class Gt{constructor(){this.db=new Y("worldSaves",1),this.tableName="test-save"}async setup(){await this.db.create(t=>{t.createObjectStore(this.tableName,{keyPath:"path"})})}async saveWorld(t,e){console.log("Saving world"),await this.db.addToObjectStore(this.tableName,{path:1,test:123,saveName:e})}}function I(a={}){let{success:t=null,message:e=""}=a;const{deltaData:s=null}=a,{followUp:n=null,cooldownMultiplier:r=1,quiet:i=!1}=a;return a instanceof Array&&([t,e]=a),{success:t,message:e,followUp:n,cooldownMultiplier:r,quiet:i,deltaData:s}}function ot(a,t,e){return a.filter(s=>s.x===t&&s.y===e)}function lt(a,t){return ot(a,t.x,t.y).filter(e=>e.entId!==t.entId)}function X(a,t,e){const s=E[e];if(!s)return[];const n=t.x+s[0],r=t.y+s[1];return ot(a,n,r)}function ct(a=[],t=""){const e=a.filter(s=>s[t]);return e.length?e[0][t]:null}function _t(a=[],t=0,e=0,s=null){let n=1/0,r=null;return a.forEach(i=>{if(s&&!s(i))return;const o=at(i.x,i.y,t,e);o<n&&(n=o,r=i)}),[r,n]}function Qt(a,t){return at(a.x,a.y,t.x,t.y)}function Jt(a,t){const e=t.x-a.x,s=t.y-a.y;return e===0&&s===0?(console.warn("Could not give a direction between",a,t),""):Math.abs(e)>Math.abs(s)?e<0?"left":"right":s<0?"up":"down"}function Zt(a,t){return(typeof a.speed=="number"?a.speed:1)*(typeof t.speed=="number"?t.speed:1)}function te(a,t){const e=(a==null?void 0:a.factions)||{},s=(t==null?void 0:t.factions)||{},n=[...Object.keys(e),...Object.keys(s)];return[...new Set(n)].reduce((o,l)=>{const c=e[l]||0,h=s[l]||0;return c===0||h===0?o:Math.sign(c)===Math.sign(h)?o+Math.min(Math.abs(c),Math.abs(h))*2:o-Math.abs(c-h)},0)}function ht(a){let t=0;return typeof a=="object"?t=L(a[0],a[1]):typeof a=="number"&&(t=a),Number.isNaN(t)?(console.error(a,"-->",t),0):t}function ee(a,t,e){const s=ht(t);return a.health.hp-=s,console.log("	",a.name,"took",s,"damage. HP:",a.health.hp,e),[s,a.health.hp]}function se(a=[],t=0,e=""){const s=ht(t),n=a.filter(l=>l.health),r=Math.floor(s/n.length),i=s-r*n.length;return n.map((l,c)=>ee(l,c===0?r+i:r,e))}function ne(a){var t;return!a.firer||!a.firer.natural?0:((t=a==null?void 0:a.firer)==null?void 0:t.range)||0}function y(a){var t,e;return((t=a==null?void 0:a.health)==null?void 0:t.hp)&&((e=a==null?void 0:a.health)==null?void 0:e.hp)>0}function re(a,t){zt(t,a)}function ae(a,t=0){a.experience&&(a.experience.totalXp+=t)}function ie(a,t){!a.experience||!t.experience||t.experience.killXp&&ae(a,t.experience.killXp)}function oe(a){var i,o;if(!a.attacker)return[0,""];const t=((i=a.attacker)==null?void 0:i.natural.damage)||0,e=typeof t=="number"?t:t[1]||0,s=0,n="";return e>0?[t,((o=a.attacker)==null?void 0:o.natural.damageType)||""]:[s,n]}function le(a){var t;return((t=a==null?void 0:a.attacker)==null?void 0:t.range)||0}function ce(a,t,e,s){let n=X(e,a,s);if(!n.length)return[!0,`No one to fight (${s}).`];if(n=n.filter(d=>y(d)),!n.length)return[!0,`No effect! (fight ${s})`];const[r,i]=oe(a),c=se(n,r,i).map(d=>d[0]).join(",");let h=0;n.forEach(d=>{y(d)||(h+=1,re(a,d),ie(a,d))});let u="";return h===1?u=` and kill ${n[0].name}`:h>1&&(u=` and kill ${h} enemies`),[!0,`Attack for ${c} damage${u}`]}function he(a,t,e){if(!a.enterer)return[!1,"You cannot enter."];const s=ct(lt(e,a),"enter");if(!s){const r=this.klimb(a,t,e),{success:i}=I(r);return i?r:[!1,"There is nothing to enter."]}if(!s.mapKey)return[!1,"Error entering!"];const n=[s.mapKey];return{success:!0,message:"You enter a new location.",followUp:["moveActorMap",a,n]}}function ue(a){var t;return(((t=a==null?void 0:a.currencies)==null?void 0:t.food)||0)>0}function de(a){return(a==null?void 0:a.eater)&&!ue(a)}function ut(a,t){var n,r,i;if(!((n=a==null?void 0:a.currencies)!=null&&n.food)||!((r=a==null?void 0:a.eater)!=null&&r.moveMeal))return!1;const{moveMealMultiplier:e=1}=t.base,s=(((i=a==null?void 0:a.eater)==null?void 0:i.moveMeal)||0)*e;return a.currencies.food=Math.max(0,a.currencies.food-s),!0}function K(a,t){var e;if(a.isAvatar&&a.mover&&(a.mover.movesCount=(a.movesCount||0)+1),ut(a,t),typeof((e=a==null?void 0:a.experience)==null?void 0:e.totalXp)=="number"){const{moveXpMultiplier:s=0}=t.base;a.experience.totalXp+=1*s}}function pe(a,t,e,s,n,r){if(!a.exitor)return[!1,"You cannot exit."];const i=t.getExit(e);if(i instanceof Array)return K(a,t),{success:!0,message:`You leave ${t.getName()}.`,followUp:["moveActorMap",a,i]};if(i==="BLOCK")return[!1,`Blocked ${r}.`];if(i==="LOOP"){const[o,l]=t.getLoopedCoordinates(s,n);return a.x=o,a.y=l,K(a,t),[!0,`You move ${r}`]}return[!1,"You cannot move."]}function me(a,t,e,s){const{mover:n}=a;if(!n)return[!1,"You cannot move"];const r=E[s];if(!r)return[!1,"Invalid direction to move"];const i=a.x+r[0],o=a.y+r[1],l=t.getOffEdge(i,o);if(l)return pe(a,t,l,i,o,s);const u=[t.getTerrainEntity(i,o).obstacleId,...e.filter(g=>g.x===i&&g.y===o).filter(g=>!g.isActor||y(g)).map(g=>g.obstacleId)].map(g=>(n==null?void 0:n.transversal[g])||0),d=Math.min(...u);if(!d)return[!1,`Blocked ${s}.`];a.x=i,a.y=o,K(a,t);const v=1/d*(de(a)?2:1);return{success:!0,message:`You move ${s}.`,cooldownMultiplier:v}}function fe(a,t){return ut(a,t),[!0,"You wait a moment."]}function ge(a,t,e,s,n){const r=n.runAction("transact",a,t,e,s);return r.success?r:[!1,`Talk ${s} not yet implemented.`]}const we=10;function ye(a={}){var s,n,r,i;let t=1;t+=(((s=a.attackable)==null?void 0:s.damage)||0)*1,t+=(((n=a.attackable)==null?void 0:n.range)||0)*2,t+=(((r=a.buff)==null?void 0:r.spellDamageBonus)||0)*5,t+=(((i=a.buff)==null?void 0:i.defense)||0)*5;const{valueMultiplier:e=1}=a.valuable;return Math.max(0,Math.round(t*e))}function be(a={},t=null,e=0){const{sell:s={},markUp:n=2}=a;if(s.stock)return a;const r=s.types.filter((i,o)=>{var l;return s.gateByMovesCount?e>=((l=s.gateByMovesCount)==null?void 0:l[o])||0:!0});return s.stock=r.map((i,o)=>{var u,d;const l=t.entityTypes.createEntityByType(i),c=Math.round(ye(l)/n),h=((u=s.quantity)==null?void 0:u[o])===0?0:((d=s.quantity)==null?void 0:d[o])||we;return[l.name,i,c,h]}),a}function ve(a,t,e,s){const n=X(e,a,s).filter(o=>y(o));if(!n.length)return[!0,`No one to transact (${s}).`];const r=n[0];if(!r.shop)return[!0,`${r.name} does not buy or sell.`];const i=structuredClone(r.shop);return be(i,t),{success:!0,message:`${r.name} shows what they buy and sell...`,deltaData:{shop:i}}}const Ce=100;function Ee(a,t,e){return[!1,"Not yet implemented."]}function Te(a,t,e){return[!1,"Not yet implemented."]}function Se(a,t,e){return[!1,"Not yet implemented."]}function xe(a,t,e){return this.enter(a,t,e)}function ke(a,t,e){return[!1,"Not yet implemented."]}function Ae(a,t,e,s){return X(e,a,s).filter(r=>r.health).length?this.attack(a,t,e,s):this.fire(a,t,e,s)}function De(a,t,e,s){return[!1,"Firing not yet implemented."]}function Me(a,t,e){return[!1,"Not yet implemented."]}function Ie(a,t,e){return[!1,"Not yet implemented."]}function Le(a,t,e){return[!1,"Without precise calculations you could fly right through a star!"]}function We(a,t,e){return[!1,"Torches not yet implemented."]}function Re(a,t,e){return[!1,"Not yet implemented."]}function Ue(a,t,e){return[!1,"Junk not yet implemented."]}function Ne(a,t,e){return[!0,"You jump. Wee!"]}function qe(a,t,e){return[!1,"Jimmy not yet implemented."]}function $e(a,t,e,s){if(!a.klimber)return[!1,"You cannot climb."];const n=ct(lt(e,a),"klimbable");if(!n)return[!1,"There is nothing to climb here."];const{direction:r}=n;if(s&&r!==s)return[!1,`Cannot climb ${s} here.`];const i=t.getExit(r);return i?{success:!0,message:`You climb ${r}.`,cooldownMultiplier:Zt(a.klimber,n),followUp:["moveActorMap",a,i,!0]}:[!1,"Cannot exit the area."]}function Oe(a,t,e){return[!0,"You pretend to be a rocket. Wee!"]}function Ye(a,t,e){return[!1,"Not yet implemented."]}function Ke(a,t,e,s){return[!0,"You do not have a mortar and pestle."]}function ze(a,t,e){return[!1,"Not yet implemented."]}function Xe(a,t,e){return[!0,"You have no powers of negation yet."]}function je(a,t,e,s){return[!1,"Not yet implemented."]}function Fe(a,t,e){return[!1,"Not yet implemented."]}function Pe(a,t,e,s){return[!1,"Not yet implemented."]}function Be(a,t,e){return[!1,"Not yet implemented."]}function Ve(a,t,e){if(!a.plan)return m.enqueueWithoutWarmup(a,"pass"),{success:!1,quiet:!0,message:"No thinking."};const{randomMove:s=.5,aggroRange:n=0,hunt:r=!1}=a.plan;if(r){const[i,o]=_t(e,a.x,a.y,l=>!(!l.isActor||a.whoId===l.whoId||Qt(l,a)>n||te(l,a)>=0));if(i){const l=Jt(a,i);if(l){const c=le(a),h=ne(a),u=o<=c||o<=h?"fight":"move";return m.enqueueWithoutWarmup(a,u,l),[!0,`Planning the hunt (${u})`]}}}if(Math.random()<s){const i=Math.floor(Math.random()*4)+1;m.enqueueWithoutWarmup(a,"move",yt[i])}else m.enqueueWithoutWarmup(a,"pass");return{success:!0,message:"Plan success",quiet:!0}}function He(a,t,e,s){return[!1,"Not yet implemented."]}function Ge(a,t,e,s){return[!1,"Not yet implemented."]}function _e(a,t,e){return[!1,"Not yet implemented."]}function Qe(a,t,e,s){return[!1,"Not yet implemented."]}function Je(a,t,e,s){return{success:!0,message:`You prepare to ${s}.`,quiet:!0}}function Ze(a,t,e){return[!0,"You yell loudly."]}const z={attack:ce,board:Ee,camp:Te,cast:Se,engage:xe,enter:he,dismount:ke,fight:Ae,fire:De,get:Me,heal:Ie,hyperjump:Le,ignite:We,investigate:Re,junk:Ue,jump:Ne,jimmy:qe,klimb:$e,launch:Oe,locate:Ye,mix:Ke,move:me,navigate:ze,negate:Xe,open:je,offer:Fe,pass:fe,pickpocket:Pe,peer:Be,plan:Ve,push:He,ready:Ge,summon:_e,talk:ge,transact:ve,unlock:Qe,warmup:Je,yell:Ze},ts=Object.keys(z);class m{constructor(t={},e={}){this.actionsConfig=structuredClone(t);const{actionCooldown:s=gt,actionCooldownRandom:n=0,actionWarmup:r=wt,actionWarmupRandom:i=0}=e;this.actionCooldown=s,this.actionCooldownRandom=n,this.actionWarmup=r,this.actionWarmupRandom=i}static has(t){return ts.includes(t.toLowerCase())}static hasAction(t){return t.action?t.action.queue&&t.action.queue.length:!1}static hasReadyAction(t,e){return m.hasAction(t)?t.action.cooldown<=e:!1}static isWaitingForAction(t,e){return!m.hasAction(t)&&t.action.cooldown<=e}static handleDeadActor(t){y(t)||(t.action.queue=[["pass"]],t.action.cooldown+=Ce)}static enqueueWithoutWarmup(t,e,s){t.action.queue.push([e,s])}enqueue(t,e,s){this.getWarmupTime(e)&&t.action.queue.push(["warmup",e]),t.action.queue.push([e,s])}enqueuePlan(t){if(!y(t)){m.handleDeadActor(t);return}this.enqueue(t,"plan")}runAction(t,e,s,n,r){if(!t)throw new Error("Missing actionName");if(!z[t])throw new Error(`Invalid actionName ${t}`);const i=z[t](e,s,n,r,this);return I(i)}perform(t,e,s,n){if(!m.hasReadyAction(t,n))return I([!1,"No ready actions."]);const{action:r}=t,i=r.queue.shift(),[o,l=""]=i;if(!y(t)&&o!=="pass")return m.handleDeadActor(t),I([!1,`Cannot ${o} while dead`]);const c=this.runAction(o,t,e,s,l),{success:h,cooldownMultiplier:u}=c;if(h){const d=Math.max(Math.round(this.getCooldownTime(o,l)*u),1);r.cooldown=Math.ceil(n+d)}return c}getWarmupTime(t){var e;return(((e=this.actionsConfig[t])==null?void 0:e.warmup)||0)*(this.actionWarmup+L(this.actionWarmupRandom))}getCooldownTime(t,e){var s;return t==="warmup"?this.getWarmupTime(e):(((s=this.actionsConfig[t])==null?void 0:s.cooldown)||0)*(this.actionCooldown+L(this.actionCooldownRandom))}}class es{constructor(t={},e={},s=null){this.worldComm=s,this.entityTypes=new x(t==null?void 0:t.entityTypes),this.actions=new m(e,t==null?void 0:t.timing),this.time=0,this.maps=W.makeMaps((t==null?void 0:t.maps)||{},t==null?void 0:t.globalLegend,t==null?void 0:t.mapTypes,this.entityTypes),this.connections={},this.ents=new jt(this.entityTypes),this.schedulerQueues={},this.worldLog=[],this.deltas=[],this.maxDeltas=99,this.ents.allAllFromMaps(this.maps),this.saveLoadManager=new Gt}async load(){const t=this.maps.findIndex(e=>e.mapKey==="overworld");this.ents.addAvatar({type:"avatar",whoId:"my-avatar-1",mapId:t,x:10,y:6,stats:{}}),this.time=100,this.maps.forEach(e=>{e.time=this.time}),this.ents.getActors().forEach(e=>{e.action.cooldown=this.time}),this.updateAllClients(),await this.saveLoadManager.setup(),this.save()}async save(){await this.saveLoadManager.saveWorld(this,"test-save")}connect(t,e={}){this.connections[t]={visibleWorldHeight:3,visibleWorldWidth:3,...e,commandQueue:[]}}getActor(t){const e=this.ents.getActor(t);return e||console.warn("Could not find",t),e}getActorMapId(t){return this.getActor(t).mapId}getActorMap(t){return this.getMap(this.getActorMapId(t))}getMap(t){return typeof t=="number"?this.maps[t]:this.maps.find(e=>e.mapKey===t)}getMapData(t){var e;return((e=this.maps[t])==null?void 0:e.getData())||{}}getTerrainSpriteAt(t,e,s){const r=this.getMap(t).getTerrainTypeKey(e,s);return this.entityTypes.getTerrainSpriteName(r)}getEntitySpriteAt(t,e,s){const r=this.ents.getEntitiesOnMap(t.id).find(i=>i.x===e&&i.y===s);return r?r.sprite:""}getTerrainSprites(t,e=0,s=0,n=10,r=10){const i=[];for(let o=0;o<r;o+=1){i[o]||(i[o]=[]);for(let l=0;l<n;l+=1)i[o][l]=this.getTerrainSpriteAt(t,e+l,s+o)}return i}getPropsSprites(t,e=0,s=0,n=10,r=10){const i=this.getMap(t),o=[];for(let l=0;l<r;l+=1){o[l]||(o[l]=[]);for(let c=0;c<n;c+=1)o[l][c]=this.getEntitySpriteAt(i,e+c,s+l)}return o}makeVisibleThing(t,e,s){return[t.sprite,t.x-e,t.y-s]}async getParty(t){const{centerVisibleWorldX:e,centerVisibleWorldY:s}=this.getVisibleWorldDimensions(t),n=this.getActor(t);return{avatar:{...n,sprite:y(n)?n.sprite:n.deadSprite,visibleWorldX:e,visibleWorldY:s}}}getVisibleWorldDimensions(t){const e=this.connections[t],{visibleWorldHeight:s,visibleWorldWidth:n}=e,r=this.getActor(t),i=Math.floor(n/2),o=Math.floor(s/2),l=r.x,c=r.y,h=l-i,u=c-o;return{w:n,h:s,centerVisibleWorldX:i,centerVisibleWorldY:o,centerWorldX:l,centerWorldY:c,worldLeftX:h,worldTopY:u}}async getVisibleWorld(t){if(!t)throw new Error("Need a whoId for getting visible world");const{w:e,h:s,worldLeftX:n,worldTopY:r}=this.getVisibleWorldDimensions(t),i=this.getActorMapId(t),o=this.ents.getEntitiesOnMapRange(i,n,r,e,s);return{terrain:{sprites:this.getTerrainSprites(i,n,r,e,s)},props:o.filter(c=>c.isProp||c.isDestination).map(c=>this.makeVisibleThing(c,n,r)),items:o.filter(c=>c.isItem).map(c=>this.makeVisibleThing(c,n,r)),actors:o.filter(c=>c.isActor&&c.whoId!==t).map(c=>{const h=this.makeVisibleThing(c,n,r);return y(c)?h:[c.deadSprite,h[1],h[2]]})}}updateAllClients(){Object.keys(this.connections).forEach(t=>this.updateClient(t))}async updateClient(t){const e=await this.getVisibleWorld(t),s=await this.getParty(t);this.worldComm.sendDataToClient({visibleWorld:e,party:s,deltas:this.deltas})}async performAction(t,e){const{mapId:s,whoId:n}=t;if(!m.hasReadyAction(t,e))return null;const r=this.getMap(s),i=this.ents.getEntitiesOnMap(s),o=this.actions.perform(t,r,i,e),{success:l,message:c,followUp:h,quiet:u,deltaData:d}=o;return h&&this[h[0]](...h.slice(1)),this.connections[n]&&await this.updateClient(n),{mapId:s,mapTime:e,success:l,message:c,quiet:u,whoId:n,worldTime:this.time,data:d}}getSimMapIds(){return this.ents.getAvatarMapIds()}async sim(t=1){this.time+=t;let e=0;const s=this.getSimMapIds();for(let n=0;n<s.length;n+=1){const r=s[n],i=this.getMap(r);let o=!1,l;for(;i.time<this.time&&!o;)l=this.time-i.time,o=await this.simMap(r,l);o&&(e+=1)}e?this.updateAllClients():(await it(10),this.sim(t))}async simMap(t,e){if(e<0)throw new Error("Invalid time step");e>1&&console.log("Simulating map",e,"steps to get to",this.time);const s=this.getMap(t);s.time=Math.min(this.time,s.time+e);const n=this.ents.getActorsOnMap(t);this.schedulerQueues[t]||(this.schedulerQueues[t]=new Ft(n));const r=this.schedulerQueues[t],i=r.top();if(m.isWaitingForAction(i,s.time)){if(i.isAvatar)return console.log("Map Sim",s.time,"Top actor is avatar and has nothing to do."),!0;this.actions.enqueuePlan(i)}const o=await this.performAction(i,s.time);return o&&(o.quiet||(this.deltas.push(o),this.deltas.length>this.maxDeltas&&this.deltas.splice(0,this.deltas.length-this.maxDeltas))),r.sort(),!1}moveActorMap(t,e=[],s=!1){const[n,r,i]=e,o=this.getMap(n);if(t.mapId=o.id,s){typeof r=="number"&&typeof i=="number"?(t.x+=r,t.y+=i):console.error("invalid coordinates");return}if(typeof r=="number"&&typeof i=="number")t.x=r,t.y=i;else{const[l,c]=o.getEntranceCoordinates();t.x=l,t.y=c}}ping(){return[!0,"ping"]}async runCommand(t,e){const s=t instanceof Array?[...t]:String(t).toLowerCase().split(" "),r={hole:"camp",inform:"investigate",search:"investigate",steal:"pickpocket",wear:"ready",equip:"ready",exit:"dismount",mount:"board",stats:"ztats",go:"move"}[s[0]];r&&(s[0]=r);const i=s[0],o=["chat","descend","exit","karma","look","map","navigate","party","ping","quicksave","quit","view","zstats"],l=s.slice(1),c=this.getActor(e);if(this[i]){if(!o.includes(i))return{success:!1,message:`Command not allowed '${i}'`};const[h,u]=await this[i](c,...l);return this.sim(),{success:h,message:u}}return m.has(i)?c.action?(console.log("World enqueue action:",i,l),this.actions.enqueue(c,i,l.join(" ")),this.sim(),{success:!0,message:"Action queued"}):{success:!1,message:`${e} cannot do actions.`}:(console.error("Invalid command",i),{success:!1,message:`Invalid command '${i}'`})}}class ss extends tt{constructor(t={}){super(),this.localWorld=null,this.visibleWorldHeight=0,this.visibleWorldWidth=0,t.world&&this.startLocalWorld(t.world,t.actions)}async startLocalWorld(t,e){this.localWorld=new es(t,e,this),window.world=this.localWorld,await this.localWorld.load()}async connect(t,e,s){this.localWorld.connect(t,{visibleWorldHeight:s,visibleWorldWidth:e})}async load(){}async sendCommandToWorld(t,e){if(!t)return console.warn("Cannot send a blank command"),[];if(!e)throw new Error("Must send a command on behalf of a user (whoId missing)");const s=await this.localWorld.runCommand(t,e),n=await this.localWorld.getVisibleWorld(e),r=await this.localWorld.getParty(e);return[s,n,r]}async sendDataToClient(t){this.trigger("data",t)}}const D=["sell","buy"];class ns{constructor(t){this.shopName=t.shopName||"Shop",this.sell=t.sell,this.buy=t.buy,this.transaction={buy:[],sell:[]},this.maxIndex=10,this.tabIndex=0,this.index=0}add(t=1){const e=D[this.tabIndex],s=this.transaction[e];let n=255;e==="sell"&&([,,,n]=this.sell.stock[this.index]),s[this.index]=$t((s[this.index]||0)+t,0,n)}subtract(t=1){this.add(-t)}tab(t=1){this.tabIndex=(D.length+this.tabIndex+t)%D.length}next(t=1){const s=D[this.tabIndex]==="sell"?this.sell.stock.length:this.maxIndex;this.index=(s+this.index+t)%s}getTextLines(){const{shopName:t="Shop",sell:e={},transaction:s={}}=this;let n="",r=[];return this.tabIndex===0?(n=" Tab =  (Buy)   Sell ",r=e.stock.map((i,o)=>{const[l,c,h,u]=i;return[o===this.index?"> ":"  ",l.padEnd(14,"."),String(s.sell[o]||0).padStart(3," "),"/",String(u).padEnd(4," "),`${h} gp`].join("")})):this.tabIndex===1&&(n=" Tab =   Buy   (Sell) ",r=["","(your inventory goes here)",""]),[`--- ${t} ---`,"",n,"",...r,""," (t) = Talk instead"," Up/Dn/W/S = Cycle between items"," Space = Select item"," (+/-) = Add or remove items"," Enter = Complete transaction"]}}function rs(a=0,t=0){return a!==0&&t!==0?null:Object.keys(E).find(e=>E[e][0]===Math.sign(a)&&E[e][1]===Math.sign(t))}class R{constructor(t={}){var e,s;this.states=t.states||{},this.inputCtrl=new qt(this.states),this.screen=new C(t),this.gameStorage=new Rt(t.gameName||"WULF"),this.worldComm=new ss({world:t.world,actions:t.actions}),this.commandIndex=0,this.mapFocus=[0,0],this.mapDisplaySizeX=(e=t==null?void 0:t.mapDisplay)==null?void 0:e.w,this.mapDisplaySizeY=(s=t==null?void 0:t.mapDisplay)==null?void 0:s.h,this.visibleWorld={},this.party={},this.avatarWhoId=null,this.renderWorldTime=0,this.volume=5,this.settings=structuredClone(t.settings),this.shopTab=0,this.shopIndex=0,this.gameShop={}}static waitForDom(){return new Promise(t=>{window.addEventListener("DOMContentLoaded",()=>t())})}async loadGame(){this.avatarWhoId="my-avatar-1",this.worldComm.load()}async sendWorldCommand(t){const[e,s,n]=await this.worldComm.sendCommandToWorld(t,this.avatarWhoId);return this.handleIncomingData({visibleWorld:s,party:n}),e}refocus(){var t,e;this.mapFocus[0]=((t=this.party)==null?void 0:t.avatar.visibleWorldX)||0,this.mapFocus[1]=((e=this.party)==null?void 0:e.avatar.visibleWorldY)||0}switchToAskDirection(t){const e=t.findIndex(s=>s==="direction");this.screen.mainConsole.print(`${_(t[0])} Direction?`),this.inputCtrl.setState("direction",s=>{if(s==="abort"){this.switchToTravel(),this.mainConsole.print("Cancel");return}const n=[...t];n[e]=s,this.screen.mainConsole.print(_(s)),this.switchToTravel(),this.executeCommand(n.join(" "))})}switchToTravel(){this.drawMap(),this.inputCtrl.setState("travel",t=>this.executeCommand(t))}switchTo(t,e){if(t==="travel"){this.switchToTravel();return}if(t==="direction"){this.switchToAskDirection();return}if(t==="commands"){this.inputCtrl.setState("commands",s=>{var i;if(s==="abort"){this.switchTo("travel");return}const n=this.getStateKeyCommands("travel");if(s==="execute"){this.switchTo("travel");const o=(i=n[this.commandIndex])==null?void 0:i.command;this.executeCommand(o);return}const r=n.length;s==="next"?this.commandIndex=(this.commandIndex+1)%r:s==="previous"&&(this.commandIndex=(r+this.commandIndex-1)%r),this.drawKeyCommandsScreen("travel")}),this.drawKeyCommandsScreen("travel");return}if(t==="shop"){this.gameShop=new ns(e.shop),this.inputCtrl.setState("shop",s=>{if(s==="abort"){this.switchTo("travel");return}s==="add"?this.gameShop.add(1):s==="subtract"&&this.gameShop.subtract(1),s==="nextTab"?this.gameShop.tab(1):s==="previousTab"&&this.gameShop.tab(-1),s==="next"?this.gameShop.next(1):s==="previous"&&this.gameShop.next(-1),this.drawShop()}),this.drawShop();return}console.warn("Unknown state",t)}async executeCommand(t){await it(10),console.log("		Client Command:",t);const e={vol:"volume"},s={volume:o=>{let l=0;o==="up"?l=1:o==="down"&&(l=-1),this.volume=Math.min(Math.max(this.volume+l,bt),vt),this.screen.mainConsole.print(`Volume: ${this.volume}`)},switch:o=>this.switchTo(o),see:o=>this.switchTo(o),abort:()=>{this.switchToTravel()},view:()=>{},chat:()=>{}},n=String(t).toLowerCase().split(" "),r=e[n[0]];r&&(n[0]=r);const i=s[n[0]];if(i){const o=n.slice(1);await i(...o);return}if(n.includes("nearby")){const o=n.findIndex(u=>u==="nearby"),{visibleWorldX:l,visibleWorldY:c}=this.party.avatar,h=this.findVisibleEntitiesNearby(l,c);if(h.length===1){const[,u,d]=h[0],p=rs(u-l,d-c);p&&(n[o]=p)}else n[o]="direction"}if(n.includes("direction")){this.switchToAskDirection(n);return}await this.sendWorldCommand(n)}getMapFocusTopLeft(){const[t,e]=this.mapFocus;return[t-Math.floor(this.mapDisplaySizeX/2),e-Math.floor(this.mapDisplaySizeY/2)]}findVisibleEntitiesAt(t,e,s=["actors","items","props"]){const n=[];return s.forEach(r=>{this.visibleWorld[r].forEach(i=>{const[,o,l]=i;o===t&&l===e&&n.push(i)})}),n}findVisibleEntitiesNearby(t,e,s){let n=[];return Object.values(E).forEach(([r,i])=>{const o=this.findVisibleEntitiesAt(t+r,e+i,s);n=[...n,...o]}),n}drawMap(t){this.screen.drawMap(this.visibleWorld,this.party,t)}getStateKeyCommands(t){const{kb:e={},hideCommands:s=[],keyHelp:n={}}=this.states[t];return Object.keys(e).filter(r=>!s.includes(r)).map(r=>({key:r,command:e[r],keyHelp:n[r]}))}drawKeyCommandsScreen(t){const e=this.getStateKeyCommands(t),s={ArrowUp:"Up",ArrowDown:"Down",ArrowLeft:"Left",ArrowRight:"Right"," ":"Space"},n=e.map(({key:r,command:i,keyHelp:o={}},l)=>{const c=s[r]||r,h=o[this.settings.language]||i;return`${this.commandIndex===l?">":" "}(${c}) ${h}`});this.screen.drawCommandColumns(n)}drawShop(){this.drawMap(!0),this.screen.drawCentralText(this.gameShop.getTextLines())}drawAll(){this.screen.drawAll(this.visibleWorld,this.party)}static loopDeltas(t=[],e=0,s=0,n=()=>{}){let r;for(let i=t.length-1;i>=0;i-=1)if(r=t[i],r.worldTime<e||r.worldTime<=s&&n(r))return}drawDeltas(t=[],e=0,s=0){const n=[];R.loopDeltas(t,e,s,r=>{const{whoId:i,message:o,quiet:l,worldTime:c}=r;this.renderWorldTime<c&&i===this.avatarWhoId&&!l&&n.push(o)});for(let r=n.length-1;r>=0;r-=1)console.log("		Print",n[r]),this.screen.mainConsole.print(n[r])}handleDeltas(t=[]){var i;if(!t)return null;const e=this.renderWorldTime,s=((i=t[t.length-1])==null?void 0:i.worldTime)||0;this.drawDeltas(t,e,s),this.renderWorldTime=s;const n=t.filter(o=>o.data);if(!n.length)return null;const r=n[n.length-1].data;return r.shop?{...r,stateName:"shop"}:{...r}}handleIncomingData(t){const{visibleWorld:e,party:s,deltas:n}=t;this.visibleWorld=Object.freeze(structuredClone(e)),this.party=Object.freeze(structuredClone(s));const r=this.handleDeltas(n);this.refocus(),this.drawAll(),r&&r.stateName&&this.switchTo(r.stateName,r)}async setup(){await R.waitForDom(),await this.screen.setup(),this.screen.mainConsole.print("You enter a swirling gateway, and awaken in a strange world."),this.loadGame(),this.worldComm.on("data",t=>this.handleIncomingData(t)),await this.worldComm.connect(this.avatarWhoId,this.mapDisplaySizeX,this.mapDisplaySizeY),await this.sendWorldCommand("ping",this.avatarWhoId),this.drawMap(),this.inputCtrl.setup(),this.switchToTravel()}async start(){await this.setup(),console.log("%c☥","font-size: 300%; color: #ff0;")}}const dt=new R(Mt);dt.start();window.g=dt;
